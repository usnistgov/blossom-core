# Asset Chaincode

## Table of Contents
- [Organizational Terms](#organizational-terms)
- [Actors for Organizations](#actors-for-organizations)
- [Transient Requests](#transient-requests)
  - [AccountRequest](#AccountRequest)
  - [AddAssetRequest](#AddAssetRequest)
  - [AddLicensesRequest](#AddLicensesRequest)
  - [RemoveLicensesRequest](#RemoveLicensesRequest)
  - [UpdateEndDateRequest](#UpdateEndDateRequest)
  - [AllocateLicensesRequest](#AllocateLicensesRequest)
  - [AssetIdAndAccountRequest](#AssetIdAndAccountRequest)
  - [AssetIdRequest](#AssetIdRequest)
  - [GetLicenseTxHistoryRequest](#GetLicenseTxHistoryRequest)
  - [QuoteRequest](#QuoteRequest)
  - [OrderIdAndAccountRequest](#OrderIdAndAccountRequest)
  - [OrderIdRequest](#OrderIdRequest)
  - [ReportSWIDRequest](#ReportSWIDRequest)
  - [SWIDRequest](#SWIDRequest)
- [Responses](#responses)
  - [AssetDetailResponse](#AssetDetailResponse)
  - [AssetResponse](#AssetResponse)
  - [IdResponse](#IdResponse)
- [Data Model](#data-model)
  - [License](#License)
  - [Allocated](#Allocated)
  - [LicensesRequest](#LicensesRequest)
  - [Asset](#Asset)
  - [Order](#Order)
    - [Status (enum)](#status-(enum))
  - [SWID](#swid)
- [Asset Contract](#asset-contract)
  - [AddAsset](#AddAsset)
  - [AddLicenses](#AddLicenses)
  - [RemoveLicenses](#RemoveLicenses)
  - [UpdateEndDate](#UpdateEndDate)
  - [RemoveAsset](#RemoveAsset)
  - [GetAssets](#GetAssets)
  - [GetAsset](#GetAsset)
- [Order Contract](#order-contract)
  - [GetQuote](#GetQuote)
  - [SendQuote](#SendQuote)
  - [InitiateOrder](#InitiateOrder)
  - [ApproveOrder](#ApproveOrder)
  - [DenyOrder](#DenyOrder)
  - [GetLicensesToAllocateForOrder](#GetLicensesToAllocateForOrder)
  - [GetAllocateRequestForOrder](#GetAllocateRequestForOrder)
  - [SendLicenses](#SendLicenses)
  - [InitiateReturn](#InitiateReturn)
  - [GetInitiatedReturnForOrder](#GetInitiatedReturnForOrder)
  - [DeallocateLicensesFromAccount](#DeallocateLicensesFromAccount)
  - [DeallocateLicensesFromSP](#DeallocateLicensesFromSP)
  - [GetOrder](#GetOrder)
  - [GetOrdersByAccount](#GetOrdersByAccount)
  - [GetOrdersByAccountAndAsset](#GetOrdersByAccountAndAsset)
  - [GetOrdersByAsset](#GetOrdersByAsset)
  - [GetAllocatedLicenses](#GetAllocatedLicenses)
  - [GetExpiredOrders](#GetExpiredOrders)
- [SWID Contract](#swid-contract)
  - [ReportSWID](#ReportSWID)
  - [DeleteSWID](#DeleteSWID)
  - [GetSWID](#GetSWID)
  - [GetSWIDsAssociatedWithAsset](#GetSWIDsAssociatedWithAsset)
## Organizational Terms

1. Requesting Organization (RO) - Needs license(s)
2. Service Provider (SP) - Agency that purchased the leased licenses
3. ADMINMSP - MSPID of the SP
4. PDC - Private Data Collection
5. IPDC - Implicit Private Data Collection

## Actors for Organizations

1. Acquisition Officer (ACQ)
2. Technical Point of Contact (TPOC)
3. System Owner (SO)
## Transient Requests

### AccountRequest
```json
{
  "request": {
    "account": "account MSPID"
  }
}
```
### AddAssetRequest
The `salt` field for each license is generated by the client and used when hashing the license. This hash is then put on the public ledger to track the transactions for the license. The salt field is only available to the SP.
```json
{
  "request": {
    "name": "asset name",
    "endDate": "YYYY-MM-DD",
    "licenses": [
      {
        "id": "licenseId",
        "salt": "client generated salt"
      }
    ]
  }
}
```
### AddLicensesRequest
```json
{
  "request": {
    "assetId": "asset ID",
    "licenses": [
      {
        "id": "licenseId",
        "salt": "client generated salt"
      }
    ]
  }
}
```
### RemoveLicensesRequest
```json
{
  "request": {
    "assetId": "asset ID",
    "licenses": [
      "license1",
      "license2"
    ]
  }
}
```
### UpdateEndDateRequest
```json
{
  "request": {
    "assetId": "asset ID",
    "newEndDate": "YYYY-MM-DD"
  }
}
```
### AllocateLicensesRequest
```json
{
  "request": {
    "orderId": "order ID",
    "account": "account MSPID",
    "licenses": [
      "license1",
      "license2"
    ]
  }
}
```
### AssetIdAndAccountRequest
```json
{
  "request": {
    "assetId": "order ID",
    "account": "account MSPID"
  }
}
```
### AssetIdRequest
```json
{
  "request": {
    "assetId": "order ID"
  }
}
```
### GetLicenseTxHistoryRequest
```json
{
  "request": {
    "assetId": "order ID",
    "licenseId": "license ID"
  }
}
```
### QuoteRequest
#### GetQuoteRequest
The `duration` field specifies how long the lease will last in **years**.
```json
{
  "request": {
    "assetId": "asset ID",
    "amount": 20,
    "duration": 2
  }
}
```
#### SendQuoteRequest
```json
{
  "request": {
    "orderId": "order ID",
    "price": 100.37
  }
}
```
### OrderIdAndAccountRequest
```json
{
  "request": {
    "account": "account MSPID",
    "orderId": "order ID"
  }
}
```
### OrderIdRequest
```json
{
  "request": {
    "orderId": "order ID"
  }
}
```
### ReturnLicensesRequest
```json
{
  "request": {
    "orderId": "order ID",
    "account": "account MSPID",
    "assetId": "asset ID",
    "licenses": [
      "license1",
      "license2"
    ]
  }
}
```
### ReportSWIDRequest
```json
{
  "request": {
    "account": "account MSPID",
    "primaryTag": "SWID primary tag",
    "xml": "SWID full XML or pointer to full XML",
    "assetId": "ID of associated asset",
    "licenseId": "ID of associated license"
  }
}
```
### SWIDRequest
```json
{
  "request": {
    "account": "account MSPID",
    "licenseId": "license ID"
  }
}
```

## Responses

### AssetDetailResponse
```json
{
  "id": "asset ID",
  "name": "asset name",
  "numAvailable": 20,
  "startDate": "YYYY-MM-DD",
  "endDate": "YYYY-MM-DD",
  "totalAmount": 20,
  "availableLicenses": ["license1", "license2", "license3"],
  "allocatedLicenses": {
    "account MSPID": {
      "orderId": [
        {
          "licenseId": "license ID",
          "expiration": "expiration"
        }
      ]
    }
  }
}
```
### AssetResponse
```json
{
  "id": "asset ID",
  "name": "asset name",
  "numAvailable": 20,
  "startDate": "YYYY-MM-DD",
  "endDate": "YYYY-MM-DD"
}
```
### IdResponse
```json
{
  "id": "ID"
}
```

### AllocateLicensesResponse
```json
{
  "orderId": "order ID",
  "account": "account MSPID",
  "licenses": [
    "license1",
    "license2"
  ]
}
```

## Data Model
The following data models are JSON representations of the objects that get written to the private data collections/ledger.
### License
```json
{
  "id": "assetId",
  "salt": "salt",
  "allocated": {
    "licenseId": "license ID",
    "account": "account MSPID",
    "expiration": "YYYY-MM-DD",
    "orderId": "order ID"
  }
}
```
### Allocated
```json
{
  "licenseId": "license ID",
  "account": "account MSPID",
  "expiration": "YYYY-MM-DD",
  "orderId": "order ID"
}
```
### LicensesRequest
```json
{
  "account": "account MSPID",
  "assetId": "asset ID",
  "orderId": "order ID",
  "expiration": "YYYY-MM-DD",
  "licenses": [
    "license1",
    "license2"
  ]
}
```
### Asset
```json
{
  "id": "asset ID",
  "name": "asset name",
  "startDate": "YYYY-MM-DD",
  "endDate": "YYYY-MM-DD"
}
```
### Order
```json
{
  "id": "order ID",
  "account": "account MSPID",
  "status": "order status",
  "initiaionDate": "YYYY-MM-DD",
  "approvalDate": "YYYY-MM-DD",
  "allocatedDate": "YYYY-MM-DD",
  "latestRenewalDate": "YYYY-MM-DD",
  "assetId": "asset ID",
  "amount": 20,
  "duration": 2,
  "price": 100.37,
  "expiration": "YYYY-MM-DD",
  "licenses": [
    "license1",
    "license2"
  ]
}
```
#### Status (enum)
```json
{
  "status": [
    "QUOTE_REQUESTED",
    "QUOTE_RECEIVED",
    "INITIATED",
    "APPROVED",
    "DENIED",
    "ALLOCATED",
    "RENEWAL_QUOTE_REQUESTED",
    "RENEWAL_QUOTE_RECEIVED",
    "RENEWAL_INITIATED",
    "RENEWAL_APPROVED",
    "RENEWAL_DENIED"
  ]
}
```
### SWID
```json
{
  "id": "swid ID",
  "primaryTag": "swid primaryTag",
  "xml": "swid xml",
  "assetId": "asset ID",
  "licensesId": "license ID"
}
```
## Asset Contract
### AddAsset
Add a new asset.

- transient: [AddAssetRequest](#AddAssetRequest)
- output: [IdResponse](#IdResponse)
- NGAC policy requirements:
  - Role: SO
  - Account: SP
  - Status: Authorized
### AddLicenses
Add licenses to an already created asset.

- transient: [AddLicensesRequest](#AddLicensesRequest)
- output: none
- NGAC policy requirements:
  - Role: SO
  - Account: SP
  - Status: Authorized

### RemoveLicenses
Remove the given licenses from the asset's pool. An error will occur if a license is currently allocated.

- transient: [RemoveLicensesRequest](#RemoveLicensesRequest)
- output: none
- NGAC policy requirements:
  - Role: SO
  - Account: SP
  - Status: Authorized

### UpdateEndDate
Update the end date for an asset.

- transient: [UpdateEndDateRequest](#UpdateEndDateRequest)
- output: none
- NGAC policy requirements:
  - Role: SO
  - Account: SP
  - Status: Authorized

### RemoveAsset
Remove the asset from the catalog.

- transient: [AssetIdRequest](#AssetIdRequest)
- output: none
- NGAC policy requirements:
  - Role: SO
  - Account: SP
  - Status: Authorized
### GetAssets
Get all assets.

- transient: none
- output: [AssetResponse](#AssetResponse)
- NGAC policy requirements:
  - Role: SO, ACQ, TPOC
  - Account: any
  - Status: Authorized
### GetAsset
Get the asset with the given ID.

- transient: [AssetIdRequest](#AssetIdRequest)
- output: [AssetDetailResponse](#AssetDetailResponse)
- NGAC policy requirements:
  - Role: SO, ACQ, TPOC
  - Account: any
  - Status: Authorized

### GetLicenseTxHistory
Get the transaction history of a given license. This will return a list of the transaction IDs from the public ledger in which the given license was updated on the SP IPDC.

- transient: [AssetIdRequest](#AssetIdRequest)
- output: String[]
- NGAC policy requirements:
  - Role: SO
  - Account: SP
  - Status: Authorized

## Order Contract

### GetQuote
Get a quote from the SP for licenses of the given asset for a given amount and duration.

- transient: [QuoteRequest](#QuoteRequest)
- output: [IdResponse](#IdResponse)
- NGAC policy requirements:
  - Role: TPOC
  - Account: RO
  - Status: Authorized

### SendQuote
Send a quote in response to GetQuote with a price.

- transient: [QuoteRequest](#QuoteRequest)
- output: [IdResponse](#IdResponse)
- NGAC policy requirements:
  - Role: ACQ
  - Account: SP
  - Status: Authorized
### InitiateOrder
Initiate an order based on an already existing quote. A quote is required to initiate an order.

- transient: [OrderIdAndAccountRequest](#OrderIdAndAccountRequest)
- output: [IdResponse](#IdResponse)
- NGAC policy requirements:
  - Role: TPOC
  - Account: RO
  - Status: Authorized
### ApproveOrder
Approve an order that has been initiated based on the given order ID.

- transient: [OrderIdAndAccountRequest](#OrderIdAndAccountRequest)
- output: [IdResponse](#IdResponse)
- NGAC policy requirements:
  - Role: ACQ
  - Account: RO
  - Status: Authorized
### DenyOrder
Deny an order that has been initiated based on the given order ID.

- transient: [OrderIdAndAccountRequest](#OrderIdAndAccountRequest)
- output: [IdResponse](#IdResponse)
- NGAC policy requirements:
  - Role: ACQ
  - Account: RO
  - Status: Authorized

### GetLicensesToAllocateForOrder
Step 1 in the allocation process. Identify the licenses that can be allocated in response to an order. This method does not write to the SP IPDC just queries for available licenses which means it is not guaranteed the licenses returned will be available in the next step. This is a limitation of Fabric private data collections. You cannot perform range queries and then write to a PDC in the same transaction.

- transient: [OrderIdAndAccountRequest](#OrderIdAndAccountRequest)
- output: [AllocateLicensesResponse](#AllocateLicensesResponse)
- NGAC policy requirements:
  - Role: ACQ
  - Account: SP
  - Status: Authorized
  - 
### AllocateLicenses
Step 2 in the allocation process. Take the return value of step 1 (GetLicensesToAllocateForOrder) and pass as transient input to allocate the licenses in the SP IPDC. This will create an allocation request in the SP IPDC and return it to be used in step 3 and 4.

- transient: [AllocateLicensesRequest](#AllocateLicensesRequest)
- output: [LicensesRequest](#LicensesRequest)
- NGAC policy requirements:
  - Role: ACQ
  - Account: SP
  - Status: Authorized

### GetAllocateRequestForOrder
Step 3 in the allocation process. Get the details of the allocation request for an order. The return value will be the same return value as AllocateLicenses in step 2.

- transient: [OrderIdRequest](#OrderIdRequest)
- output: [LicensesRequest](#LicensesRequest)
- NGAC policy requirements:
  - Role: ACQ
  - Account: SP
  - Status: Authorized
### SendLicenses
Step 4, and final step, in the allocation process. Write the allocated licenses to the ORGs IPDC. This will give the ORG access to read the licenses.

- transient: [LicensesRequest](#LicensesRequest)
- output: none
- NGAC policy requirements:
  - Role: ACQ
  - Account: SP
  - Status: Authorized
### InitiateReturn
Step 1 in the license return process. Return all or a subset of licenses for an order. The licenses are not yet deallocated from the ORG. A request is created in the SP IPDC. Only one return request for an order can be initiated at a time. The licenses being returned must be allocated to the requesting account.

- transient: [LicensesRequest](#LicensesRequest)
- output: none
- NGAC policy requirements:
  - Role: TPOC
  - Account: RO
  - Status: Authorized

### GetInitiatedReturnForOrder
Step 2 in the return process. Called by the SP to get a request to return licenses for an order.

- transient: [OrderIdRequest](#OrderIdRequest)
- output: [LicensesRequest](#LicensesRequest)
- NGAC policy requirements:
  - Role: ACQ
  - Account: SP
  - Status: Authorized
### DeallocateLicensesFromAccount
Step 3 in the return process. Checks that the provided return request matches the one that the ORG initiated. Removes the licenses from the ORG IPDC. The licenses will still be marked as allocated in the SP IPDC.

- transient: [LicensesRequest](#LicensesRequest)
- output: none
- NGAC policy requirements:
  - Role: ACQ
  - Account: SP
  - Status: Authorized

### DeallocateLicensesFromSP
Step 4, and final step, in the return process. Mark the returned licenses as returned in the SP IPDC. Checks that the provided request matches the initiated request. The transient input to this method is only an order ID and account. This is different from `DeallocateLicensesFromAccount` because we can can retrieve the returned licenses from the request stored in the SP IPDC, which is stored using the order ID and account. `DeallocateLicensesFromAccount` cannot read from the SP IPDC and write to the RO IPDC, therefore we need to provide the licenses in that request.

- transient: [OrderIdAndAccountRequest](#OrderIdAndAccountRequest)
- output: none
- NGAC policy requirements:
  - Role: ACQ
  - Account: SP
  - Status: Authorized

### GetOrder
Get an order by ID for an account.

- transient: [OrderIdAndAccountRequest](#OrderIdAndAccountRequest)
- output: [#Order](#Order)
- NGAC policy requirements:
  - Role: SO, ACQ, TPOC
  - Account: RO or SP
  - Status: Authorized

### GetOrdersByAccount
Get all orders for an account.

- transient: [AccountRequest](#AccountRequest)
- output: [Order](#Order)[]
- NGAC policy requirements:
  - Role: SO, ACQ, TPOC
  - Account: RO or SP
  - Status: Authorized
### GetOrdersByAccountAndAsset
Get orders for an account with a given asset.

- transient: [AssetIdAndAccountRequest](#AssetIdAndAccountRequest)
- output: [Order](#Order)[]
- NGAC policy requirements:
  - Role: SO, ACQ, TPOC
  - Account: RO or SP
  - Status: Authorized
### GetOrdersByAsset
Get all orders with a given asset. This will return only the orders the CID has access to. For example, SP will have access to all orders for all accounts, whereas an RO will only see the orders for the asset for their account.

- transient: [AssetIdRequest](#AssetIdRequest)
- output: [Order](#Order)[]
- NGAC policy requirements:
  - Role: SO, ACQ, TPOC
  - Account: RO or SP
  - Status: Authorized
### GetAllocatedLicenses
Get the allocated licenses for an account with the given asset ID.

- transient: [AssetIdAndAccountRequest](#AssetIdAndAccountRequest)
- output: [Allocated](#Allocated)[]
- NGAC policy requirements:
  - Role: SO, ACQ, TPOC
  - Account: RO or SP
  - Status: Authorized
### GetExpiredOrders
Get all expired orders. Only orders that the CID has access to will be returned. For ORGs this means only orders for this org. For SP, this means all orders for all ORGs.

- transient: [AssetIdAndAccountRequest](#AssetIdAndAccountRequest)
- output: [Order](#Order)[]
- NGAC policy requirements:
  - Role: any
  - Account: RO or SP
  - Status: Authorized
## SWID Contract
### ReportSWID
Report a SWID tag for a given license. Can be used to overwrite a previous report.

- transient: [ReportSWIDRequest](#ReportSWIDRequest)
- output: none
- NGAC policy requirements:
  - Role: TPOC
  - Account: RO
  - Status: Authorized
### DeleteSWID
Delete a reported SWID tag.

- transient: [SWIDRequest](#SWIDRequest)
- output: none
- NGAC policy requirements:
  - Role: TPOC
  - Account: RO
  - Status: Authorized

### GetSWID
Get a SWID tag for a given account and license ID.

- transient: [SWIDRequest](#SWIDRequest)
- output: [SWID](#SWID)
- NGAC policy requirements:
  - Role: ACQ, TPOC
  - Account: RO
  - Status: Authorized